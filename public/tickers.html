<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPTO - Ticker & Subreddit Management</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
            padding-bottom: 20px;
        }
        .header h1 {
            margin: 0;
            color: #2c3e50;
        }
        .nav-links {
            margin-top: 10px;
        }
        .nav-links a {
            color: #3498db;
            text-decoration: none;
            margin-right: 20px;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .nav-links a:hover {
            background-color: #ecf0f1;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s;
        }
        .tab:hover {
            background: #e9ecef;
        }
        .tab.active {
            background: white;
            border-bottom-color: #3498db;
            color: #3498db;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        .stats-card {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .btn:hover:not(:disabled) {
            background: #2980b9;
        }
        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        .btn.secondary {
            background: #95a5a6;
        }
        .btn.secondary:hover {
            background: #7f8c8d;
        }
        .btn.danger {
            background: #e74c3c;
        }
        .btn.danger:hover {
            background: #c0392b;
        }
        .btn.small {
            padding: 6px 12px;
            font-size: 12px;
        }
        .search-box, .input-box {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            flex: 1;
            max-width: 300px;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }
        .table tr:hover {
            background: #f8f9fa;
        }
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .badge.ticker {
            background: #3498db;
            color: white;
        }
        .badge.symbol {
            background: #2ecc71;
            color: white;
            border-radius: 4px;
            font-family: monospace;
        }
        .badge.crypto {
            background: #f39c12;
            color: white;
        }
        .badge.general {
            background: #95a5a6;
            color: white;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .success {
            background: #2ecc71;
            color: white;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .validation-status {
            padding: 8px 12px;
            border-radius: 4px;
            margin-left: 10px;
            font-size: 13px;
        }
        .validation-checking {
            background: #f39c12;
            color: white;
        }
        .validation-valid {
            background: #2ecc71;
            color: white;
        }
        .validation-invalid {
            background: #e74c3c;
            color: white;
        }
        .suggestion-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 3px solid #3498db;
        }
        .suggestion-card h4 {
            margin: 0 0 8px 0;
        }
        .suggestion-card p {
            margin: 5px 0;
            font-size: 13px;
            color: #666;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        .page-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }
        .page-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        .page-btn:hover:not(.active) {
            background: #ecf0f1;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2ecc71;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä CPTO Management</h1>
            <div class="nav-links">
                <a href="/">üè† Dashboard</a>
                <a href="/tickers">üìä Ticker Management</a>
                <a href="/backtesting.html">üìà Backtesting</a>
                <a href="/sentiment-analysis">üìâ Sentiment vs Price</a>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('tickers')">üìà Tickers</button>
            <button class="tab" onclick="switchTab('subreddits')">üì± Subreddits</button>
        </div>

        <div id="messages"></div>

        <!-- Tickers Tab -->
        <div id="tickers-tab" class="tab-content active">
            <div id="statsCard" class="stats-card">
                <strong>Ticker Status:</strong> Loading...
            </div>

            <div class="controls">
                <button class="btn" onclick="refreshTickers()">üîÑ Refresh Tickers</button>
                <button class="btn secondary" onclick="showMappings()">üìã Show Mappings</button>
                <input type="text" class="search-box" id="searchBox" placeholder="Search tickers..." onkeyup="filterTickers()">
            </div>

            <div class="controls">
                <input type="text" id="testTicker" placeholder="BTC" maxlength="10" style="width: 100px; text-transform: uppercase;">
                <button class="btn" onclick="testTicker()">Test Ticker</button>
                <div id="testResult"></div>
            </div>
            
            <!-- Analytics Controls -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                <h4 style="margin: 0 0 10px 0; font-size: 14px;">üìä Analytics & Selection</h4>
                <div class="controls">
                    <label style="font-size: 13px;">
                        Time Range:
                        <select id="analyticsTimeRange" onchange="loadTickerAnalytics()" style="padding: 5px; margin-left: 5px;">
                            <option value="1">24 Hours</option>
                            <option value="7" selected>7 Days</option>
                            <option value="30">30 Days</option>
                        </select>
                    </label>
                    <label style="font-size: 13px; margin-left: 15px;">
                        Base Currency:
                        <select id="analyticsBaseCurrency" onchange="loadTickerAnalytics()" style="padding: 5px; margin-left: 5px;">
                            <option value="USD" selected>USD</option>
                            <option value="BTC">BTC</option>
                        </select>
                    </label>
                    <button class="btn" onclick="loadTickerAnalytics()" style="margin-left: 15px;">
                        <i class="fas fa-sync"></i> Refresh Analytics
                    </button>
                    <button class="btn secondary" onclick="showTopTickersModal()" style="margin-left: 5px;">
                        üèÜ Select Top N
                    </button>
                    <button class="btn secondary" onclick="openSelectedInChart()" style="margin-left: 5px;" id="openChartBtn">
                        üìà Open Selected in Chart
                    </button>
                </div>
            </div>

            <div id="loading" class="loading">Loading supported tickers...</div>

            <div id="tickerContent" style="display: none;">
                <h3>Supported Tickers (<span id="tickerCount">0</span>)</h3>
                <table class="table" id="tickerTable">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()"></th>
                            <th onclick="sortTickerTable('ticker')" style="cursor: pointer;">Ticker <i class="fas fa-sort"></i></th>
                            <th>Gemini Symbol</th>
                            <th onclick="sortTickerTable('avgSentiment')" style="cursor: pointer;">Avg Sentiment <i class="fas fa-sort"></i></th>
                            <th onclick="sortTickerTable('priceChangePercent')" style="cursor: pointer;">Price Change % <i class="fas fa-sort"></i></th>
                            <th onclick="sortTickerTable('totalMentions')" style="cursor: pointer;">Mentions <i class="fas fa-sort"></i></th>
                            <th onclick="sortTickerTable('sentimentPriceCorrelation')" style="cursor: pointer;">Correlation <i class="fas fa-sort"></i></th>
                            <th onclick="sortTickerTable('dataPoints')" style="cursor: pointer;">Data Points <i class="fas fa-sort"></i></th>
                            <th>Enabled</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tickerTableBody"></tbody>
                </table>
                <div id="pagination" class="pagination"></div>
            </div>
        </div>

        <!-- Subreddits Tab -->
        <div id="subreddits-tab" class="tab-content">
            <div id="subredditStats" class="stats-card">
                <strong>Loading subreddit stats...</strong>
            </div>

            <h3>Add New Subreddit</h3>
            <div class="controls">
                <input type="text" id="newSubreddit" class="input-box" placeholder="Enter subreddit name (e.g., cryptotrading)" style="max-width: 250px;">
                <button class="btn" id="validateBtn" onclick="validateSubreddit()">üîç Validate</button>
                <button class="btn" id="addBtn" onclick="addSubreddit()" disabled>‚ûï Add Subreddit</button>
                <span id="validationStatus"></span>
            </div>

            <h3>Current Subreddits</h3>
            <div class="controls">
                <input type="text" class="search-box" id="subredditSearchBox" placeholder="Search subreddits..." onkeyup="filterSubreddits()">
            </div>

            <div id="subredditLoading" class="loading">Loading subreddits...</div>

            <div id="subredditContent" style="display: none;">
                <table class="table" id="subredditTable">
                    <thead>
                        <tr>
                            <th>Subreddit</th>
                            <th>Status</th>
                            <th>Type</th>
                            <th>Posts Analyzed</th>
                            <th>Date Added</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="subredditTableBody"></tbody>
                </table>
            </div>

            <h3>Suggested Subreddits</h3>
            <div class="controls">
                <button class="btn secondary" onclick="loadSuggestions()">üîÑ Refresh Suggestions</button>
            </div>

            <div id="suggestionsLoading" class="loading" style="display: none;">Loading suggestions...</div>
            <div id="suggestionsContent"></div>
        </div>
    </div>

    <script>
        // Socket.IO connection
        const socket = io();

        // Tickers Tab Variables
        let allTickers = [];
        let filteredTickers = [];
        let disabledTickers = new Set();
        let currentPage = 1;
        const tickersPerPage = 50;
        
        // Analytics Variables
        let tickerAnalytics = new Map(); // ticker -> analytics data
        let analyticsLoaded = false;
        let currentSort = { column: null, ascending: true };
        let selectedTickers = new Set();

        // Subreddits Tab Variables
        let allSubreddits = [];
        let filteredSubreddits = [];
        let validatedSubreddit = null;
        let validationDebounce = null;

        // ============= TAB SWITCHING =============
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Load data for the tab if needed
            if (tabName === 'subreddits' && allSubreddits.length === 0) {
                loadSubreddits();
            }
        }

        // ============= MESSAGING =============
        function showMessage(message, type = 'success') {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = `<div class="${type}">${message}</div>`;
            setTimeout(() => {
                messagesDiv.innerHTML = '';
            }, 5000);
        }

        function showError(message) {
            showMessage(message, 'error');
        }

        // ============= TICKERS TAB FUNCTIONS =============
        async function loadTickers() {
            try {
                const [tickersResponse, disabledResponse] = await Promise.all([
                    fetch('/api/tickers/supported'),
                    fetch('/api/tickers/disabled')
                ]);
                
                const tickersData = await tickersResponse.json();
                const disabledData = await disabledResponse.json();
                
                if (!tickersResponse.ok) {
                    throw new Error(tickersData.error || 'Failed to load tickers');
                }

                allTickers = tickersData.symbols;
                filteredTickers = [...allTickers];
                disabledTickers = new Set(disabledData.disabledTickers || []);
                
                updateTickerStats(tickersData);
                displayTickers();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('tickerContent').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading tickers:', error);
                showError('Error loading tickers: ' + error.message);
                document.getElementById('loading').innerHTML = 'Error loading tickers';
            }
        }

        function updateTickerStats(data) {
            const statsCard = document.getElementById('statsCard');
            statsCard.innerHTML = `
                <strong>Ticker Status:</strong> 
                ${data.totalSymbols} supported tickers | 
                Cache updated: ${new Date(data.cacheInfo.lastUpdated).toLocaleString()} 
                (${data.cacheInfo.cacheAge} ago)
            `;
        }

        function displayTickers() {
            const startIndex = (currentPage - 1) * tickersPerPage;
            const endIndex = startIndex + tickersPerPage;
            const pageData = filteredTickers.slice(startIndex, endIndex);
            
            const tbody = document.getElementById('tickerTableBody');
            tbody.innerHTML = '';
            
            pageData.forEach(ticker => {
                const isDisabled = disabledTickers.has(ticker.ticker);
                const isSelected = selectedTickers.has(ticker.ticker);
                const analytics = tickerAnalytics.get(ticker.ticker);
                const row = document.createElement('tr');
                
                // Reduce opacity for tickers with no data
                if (analyticsLoaded && analytics && !analytics.hasData) {
                    row.style.opacity = '0.5';
                }
                
                row.innerHTML = `
                    <td>
                        <input type="checkbox" 
                               ${isSelected ? 'checked' : ''} 
                               onchange="toggleTickerSelection('${ticker.ticker}')">
                    </td>
                    <td><span class="badge ticker">${ticker.ticker}</span></td>
                    <td><span class="badge symbol">${ticker.geminiSymbol}</span></td>
                    <td style="text-align: center;">
                        ${analytics && analytics.hasData ? analytics.avgSentiment.toFixed(3) : 'N/A'}
                    </td>
                    <td style="text-align: center;">
                        ${analytics && analytics.hasData ? analytics.priceChangePercent.toFixed(2) + '%' : 'N/A'}
                    </td>
                    <td style="text-align: center;">
                        ${analytics ? analytics.totalMentions : 'N/A'}
                    </td>
                    <td style="text-align: center;">
                        ${analytics && analytics.sentimentPriceCorrelation !== null ? analytics.sentimentPriceCorrelation.toFixed(3) : 'N/A'}
                    </td>
                    <td style="text-align: center;">
                        ${analytics ? analytics.dataPoints : 'N/A'}
                    </td>
                    <td>
                        <label class="switch">
                            <input type="checkbox" 
                                   id="toggle-${ticker.ticker}" 
                                   ${isDisabled ? '' : 'checked'} 
                                   onchange="toggleTicker('${ticker.ticker}', this.checked)">
                            <span class="slider"></span>
                        </label>
                        <span style="margin-left: 10px;">${isDisabled ? '‚ùå Disabled' : '‚úÖ Enabled'}</span>
                    </td>
                    <td>
                        ${analytics ? `<button class="btn small" onclick="viewTickerDetails('${ticker.ticker}')">üëÅÔ∏è Details</button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            document.getElementById('tickerCount').textContent = filteredTickers.length;
            updatePagination();
            updateOpenChartButton();
            
            // Update select all checkbox
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox) {
                const allPageSelected = pageData.every(t => selectedTickers.has(t.ticker));
                selectAllCheckbox.checked = allPageSelected && pageData.length > 0;
            }
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredTickers.length / tickersPerPage);
            const paginationDiv = document.getElementById('pagination');
            paginationDiv.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            if (currentPage > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.className = 'page-btn';
                prevBtn.textContent = '‚Üê Previous';
                prevBtn.onclick = () => goToPage(currentPage - 1);
                paginationDiv.appendChild(prevBtn);
            }
            
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = 'page-btn' + (i === currentPage ? ' active' : '');
                pageBtn.textContent = i;
                pageBtn.onclick = () => goToPage(i);
                paginationDiv.appendChild(pageBtn);
            }
            
            if (currentPage < totalPages) {
                const nextBtn = document.createElement('button');
                nextBtn.className = 'page-btn';
                nextBtn.textContent = 'Next ‚Üí';
                nextBtn.onclick = () => goToPage(currentPage + 1);
                paginationDiv.appendChild(nextBtn);
            }
        }

        function goToPage(page) {
            currentPage = page;
            displayTickers();
        }

        function filterTickers() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            if (!searchTerm) {
                filteredTickers = [...allTickers];
            } else {
                filteredTickers = allTickers.filter(ticker => 
                    ticker.ticker.toLowerCase().includes(searchTerm) ||
                    ticker.geminiSymbol.toLowerCase().includes(searchTerm) ||
                    ticker.tradingPair.toLowerCase().includes(searchTerm)
                );
            }
            currentPage = 1;
            displayTickers();
        }

        async function refreshTickers() {
            try {
                showMessage('Refreshing ticker data from Gemini...', 'success');
                
                const response = await fetch('/api/tickers/refresh', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to refresh tickers');
                }
                
                showMessage(`Successfully refreshed ${data.symbolCount} tickers`);
                await loadTickers();
                
            } catch (error) {
                console.error('Error refreshing tickers:', error);
                showError('Error refreshing tickers: ' + error.message);
            }
        }

        async function testTicker() {
            const ticker = document.getElementById('testTicker').value.trim().toUpperCase();
            const resultDiv = document.getElementById('testResult');
            
            if (!ticker) {
                resultDiv.innerHTML = '<span class="validation-status validation-invalid">Please enter a ticker symbol</span>';
                return;
            }
            
            try {
                const response = await fetch(`/api/tickers/test/${ticker}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Test failed');
                }
                
                const cssClass = data.isSupported ? 'validation-valid' : 'validation-invalid';
                const symbol = data.geminiSymbol ? ` ‚Üí ${data.geminiSymbol}` : '';
                resultDiv.innerHTML = `<span class="validation-status ${cssClass}">${data.message}${symbol}</span>`;
                
            } catch (error) {
                console.error('Error testing ticker:', error);
                resultDiv.innerHTML = '<span class="validation-status validation-invalid">Error testing ticker</span>';
            }
        }

        async function showMappings() {
            try {
                const response = await fetch('/api/tickers/mappings');
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load mappings');
                }
                
                let mappingText = 'Common Ticker Mappings:\n\n';
                data.mappings.forEach(mapping => {
                    mappingText += `${mapping.ticker}: ${mapping.geminiSymbols.join(', ')} (Primary: ${mapping.primary})\n`;
                });
                
                alert(mappingText);
                
            } catch (error) {
                console.error('Error loading mappings:', error);
                showError('Error loading mappings: ' + error.message);
            }
        }

        async function toggleTicker(ticker, enabled) {
            try {
                const endpoint = enabled ? 'enable' : 'disable';
                const response = await fetch(`/api/tickers/${endpoint}/${ticker}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `Failed to ${endpoint} ticker`);
                }
                
                if (enabled) {
                    disabledTickers.delete(ticker);
                } else {
                    disabledTickers.add(ticker);
                }
                
                showMessage(`${ticker} ${enabled ? 'enabled' : 'disabled'}`);
                displayTickers();
                
            } catch (error) {
                console.error(`Error toggling ticker:`, error);
                showError(`Error: ` + error.message);
                const checkbox = document.getElementById(`toggle-${ticker}`);
                if (checkbox) checkbox.checked = !enabled;
            }
        }
        
        // ============= ANALYTICS FUNCTIONS =============
        async function loadTickerAnalytics() {
            try {
                const days = document.getElementById('analyticsTimeRange').value;
                const base = document.getElementById('analyticsBaseCurrency').value;
                
                showMessage('Loading analytics...', 'success');
                
                const response = await fetch(`/api/analytics/ticker-stats?days=${days}&base=${base}&minMentions=5&includeCorrelation=false`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load analytics');
                }
                
                // Store analytics data
                tickerAnalytics.clear();
                data.stats.forEach(stat => {
                    tickerAnalytics.set(stat.ticker, stat);
                });
                
                analyticsLoaded = true;
                
                // Persist preferences
                localStorage.setItem('tickerAnalytics_days', days);
                localStorage.setItem('tickerAnalytics_base', base);
                
                // Refresh display
                displayTickers();
                
                showMessage(`Analytics loaded for ${data.count} tickers`);
                
            } catch (error) {
                console.error('Error loading analytics:', error);
                showError('Error loading analytics: ' + error.message);
            }
        }
        
        function sortTickerTable(column) {
            if (currentSort.column === column) {
                currentSort.ascending = !currentSort.ascending;
            } else {
                currentSort.column = column;
                currentSort.ascending = false; // Default to descending for metrics
            }
            
            // Sort filteredTickers
            filteredTickers.sort((a, b) => {
                let aVal, bVal;
                
                if (column === 'ticker') {
                    aVal = a.ticker;
                    bVal = b.ticker;
                    return currentSort.ascending ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                } else {
                    // Analytics columns
                    const aAnalytics = tickerAnalytics.get(a.ticker);
                    const bAnalytics = tickerAnalytics.get(b.ticker);
                    
                    if (!aAnalytics && !bAnalytics) return 0;
                    if (!aAnalytics) return 1;
                    if (!bAnalytics) return -1;
                    
                    aVal = aAnalytics[column] ?? -Infinity;
                    bVal = bAnalytics[column] ?? -Infinity;
                    
                    return currentSort.ascending ? aVal - bVal : bVal - aVal;
                }
            });
            
            currentPage = 1;
            displayTickers();
        }
        
        function toggleSelectAll() {
            const checkbox = document.getElementById('selectAllCheckbox');
            const pageData = filteredTickers.slice(
                (currentPage - 1) * tickersPerPage,
                currentPage * tickersPerPage
            );
            
            if (checkbox.checked) {
                pageData.forEach(ticker => selectedTickers.add(ticker.ticker));
            } else {
                pageData.forEach(ticker => selectedTickers.delete(ticker.ticker));
            }
            
            displayTickers();
        }
        
        function toggleTickerSelection(ticker) {
            if (selectedTickers.has(ticker)) {
                selectedTickers.delete(ticker);
            } else {
                selectedTickers.add(ticker);
            }
            updateOpenChartButton();
        }
        
        function updateOpenChartButton() {
            const btn = document.getElementById('openChartBtn');
            if (btn) {
                btn.disabled = selectedTickers.size === 0 || selectedTickers.size > 10;
                if (selectedTickers.size > 10) {
                    btn.textContent = `üìà Too many (${selectedTickers.size}/10)`;
                } else if (selectedTickers.size > 0) {
                    btn.textContent = `üìà Open ${selectedTickers.size} in Chart`;
                } else {
                    btn.textContent = 'üìà Open Selected in Chart';
                }
            }
        }
        
        function openSelectedInChart() {
            if (selectedTickers.size === 0 || selectedTickers.size > 10) {
                showError('Please select 1-10 tickers');
                return;
            }
            
            const days = document.getElementById('analyticsTimeRange').value;
            const base = document.getElementById('analyticsBaseCurrency').value;
            const tickers = Array.from(selectedTickers).join(',');
            
            window.location.href = `/sentiment-analysis?tickers=${tickers}&days=${days}&base=${base}`;
        }
        
        function showTopTickersModal() {
            const modal = prompt(
                'Select Top N Tickers\n\n' +
                'Format: metric:order:limit\n' +
                'Metrics: sentiment, price, mentions, correlation, dataPoints\n' +
                'Order: asc or desc\n' +
                'Limit: 1-20\n\n' +
                'Examples:\n' +
                '- price:desc:10 (top 10 by price change)\n' +
                '- mentions:desc:5 (top 5 by mentions)\n' +
                '- correlation:desc:10 (top 10 by correlation)',
                'price:desc:10'
            );
            
            if (!modal) return;
            
            const parts = modal.split(':');
            if (parts.length !== 3) {
                showError('Invalid format. Use metric:order:limit');
                return;
            }
            
            const metricMap = {
                sentiment: 'avgSentiment',
                price: 'priceChangePercent',
                mentions: 'totalMentions',
                correlation: 'correlation',
                dataPoints: 'dataPoints'
            };
            
            const metric = metricMap[parts[0]] || parts[0];
            const order = parts[1].toLowerCase();
            const limit = parseInt(parts[2]);
            
            if (order !== 'asc' && order !== 'desc') {
                showError('Order must be asc or desc');
                return;
            }
            
            if (isNaN(limit) || limit < 1 || limit > 20) {
                showError('Limit must be between 1 and 20');
                return;
            }
            
            selectTopTickers(metric, order, limit);
        }
        
        async function selectTopTickers(metric, order, limit) {
            try {
                const days = document.getElementById('analyticsTimeRange').value;
                const base = document.getElementById('analyticsBaseCurrency').value;
                
                showMessage(`Fetching top ${limit} tickers by ${metric}...`, 'success');
                
                const response = await fetch(
                    `/api/analytics/ticker-stats/top?metric=${metric}&order=${order}&limit=${limit}&days=${days}&base=${base}`
                );
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to get top tickers');
                }
                
                if (data.count === 0) {
                    showError('No tickers found matching criteria');
                    return;
                }
                
                // Navigate to chart with these tickers
                const tickers = data.stats.map(s => s.ticker).join(',');
                window.location.href = `/sentiment-analysis?tickers=${tickers}&days=${days}&base=${base}`;
                
            } catch (error) {
                console.error('Error selecting top tickers:', error);
                showError('Error: ' + error.message);
            }
        }
        
        function viewTickerDetails(ticker) {
            const analytics = tickerAnalytics.get(ticker);
            
            if (!analytics) {
                alert(`No analytics data available for ${ticker}`);
                return;
            }
            
            const lastAnalyzed = analytics.lastAnalyzedAt 
                ? new Date(analytics.lastAnalyzedAt).toLocaleString()
                : 'Never';
            
            const details = `
üìä Ticker Analytics: ${ticker}

` +
            `Avg Sentiment: ${analytics.hasData ? analytics.avgSentiment.toFixed(3) : 'N/A'}\n` +
            `Price Change: ${analytics.hasData ? analytics.priceChangePercent.toFixed(2) + '%' : 'N/A'}\n` +
            `Total Mentions: ${analytics.totalMentions}\n` +
            `Data Points: ${analytics.dataPoints}\n` +
            `Avg Confidence: ${analytics.hasData ? (analytics.avgConfidence * 100).toFixed(1) + '%' : 'N/A'}\n` +
            `Correlation: ${analytics.sentimentPriceCorrelation !== null ? analytics.sentimentPriceCorrelation.toFixed(3) : 'N/A'}\n` +
            `Last Analyzed: ${lastAnalyzed}\n` +
            `Has Sufficient Data: ${analytics.hasData ? 'Yes' : 'No'}`;
            
            alert(details);
        }

        // ============= SUBREDDITS TAB FUNCTIONS =============
        async function loadSubreddits() {
            try {
                document.getElementById('subredditLoading').style.display = 'block';
                document.getElementById('subredditContent').style.display = 'none';

                const response = await fetch('/api/subreddits');
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load subreddits');
                }

                allSubreddits = data.subreddits;
                filteredSubreddits = [...allSubreddits];
                
                updateSubredditStats();
                displaySubreddits();
                
                document.getElementById('subredditLoading').style.display = 'none';
                document.getElementById('subredditContent').style.display = 'block';
                
                // Load suggestions
                loadSuggestions();
                
            } catch (error) {
                console.error('Error loading subreddits:', error);
                showError('Error loading subreddits: ' + error.message);
                document.getElementById('subredditLoading').innerHTML = 'Error loading subreddits';
            }
        }

        function updateSubredditStats() {
            const active = allSubreddits.filter(s => s.enabled).length;
            const cryptoFocused = allSubreddits.filter(s => s.is_crypto_focused).length;
            const totalPosts = allSubreddits.reduce((sum, s) => sum + s.last_post_count, 0);
            
            const statsCard = document.getElementById('subredditStats');
            statsCard.innerHTML = `
                <strong>Subreddit Status:</strong> 
                ${allSubreddits.length} total | 
                ${active} active | 
                ${cryptoFocused} crypto-focused | 
                ${totalPosts} posts analyzed
            `;
        }

        function displaySubreddits() {
            const tbody = document.getElementById('subredditTableBody');
            tbody.innerHTML = '';
            
            filteredSubreddits.forEach(subreddit => {
                const row = document.createElement('tr');
                const dateAdded = new Date(subreddit.added_at).toLocaleDateString();
                
                row.innerHTML = `
                    <td><strong>r/${subreddit.subreddit}</strong></td>
                    <td>
                        <label class="switch">
                            <input type="checkbox" 
                                   ${subreddit.enabled ? 'checked' : ''} 
                                   onchange="toggleSubreddit('${subreddit.subreddit}', this.checked)">
                            <span class="slider"></span>
                        </label>
                        <span style="margin-left: 10px;">${subreddit.enabled ? '‚úÖ Active' : '‚è∏Ô∏è Paused'}</span>
                    </td>
                    <td><span class="badge ${subreddit.is_crypto_focused ? 'crypto' : 'general'}">${subreddit.is_crypto_focused ? 'ü™ô Crypto' : 'üì∞ General'}</span></td>
                    <td>${subreddit.last_post_count}</td>
                    <td>${dateAdded}</td>
                    <td>
                        <button class="btn danger small" onclick="removeSubreddit('${subreddit.subreddit}')">üóëÔ∏è Remove</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterSubreddits() {
            const searchTerm = document.getElementById('subredditSearchBox').value.toLowerCase();
            if (!searchTerm) {
                filteredSubreddits = [...allSubreddits];
            } else {
                filteredSubreddits = allSubreddits.filter(s => 
                    s.subreddit.toLowerCase().includes(searchTerm)
                );
            }
            displaySubreddits();
        }

        async function validateSubreddit() {
            const input = document.getElementById('newSubreddit');
            let subreddit = input.value.trim().toLowerCase();
            
            // Strip r/ prefix if present
            subreddit = subreddit.replace(/^\/?(r\/)?/, '');
            
            if (!subreddit) {
                document.getElementById('validationStatus').innerHTML = '<span class="validation-status validation-invalid">Please enter a subreddit name</span>';
                document.getElementById('addBtn').disabled = true;
                return;
            }
            
            // Show checking status
            document.getElementById('validationStatus').innerHTML = '<span class="validation-status validation-checking">üîç Checking...</span>';
            document.getElementById('addBtn').disabled = true;
            
            try {
                const response = await fetch(`/api/subreddits/validate/${subreddit}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Validation failed');
                }
                
                const validation = data.validation;
                validatedSubreddit = { name: subreddit, ...validation };
                
                if (validation.exists && !validation.isPrivate && !validation.isBanned) {
                    const cryptoLabel = validation.isCryptoFocused ? 'ü™ô Crypto-focused' : 'üì∞ General';
                    const subCount = validation.subscribers ? `${validation.subscribers.toLocaleString()} subscribers` : '';
                    document.getElementById('validationStatus').innerHTML = `<span class="validation-status validation-valid">‚úÖ Valid ${cryptoLabel} ${subCount}</span>`;
                    document.getElementById('addBtn').disabled = false;
                } else {
                    let reason = 'Not accessible';
                    if (!validation.exists) reason = 'Does not exist';
                    else if (validation.isPrivate) reason = 'Private';
                    else if (validation.isBanned) reason = 'Banned';
                    
                    document.getElementById('validationStatus').innerHTML = `<span class="validation-status validation-invalid">‚ùå ${reason}</span>`;
                    document.getElementById('addBtn').disabled = true;
                }
                
            } catch (error) {
                console.error('Error validating subreddit:', error);
                document.getElementById('validationStatus').innerHTML = '<span class="validation-status validation-invalid">‚ùå Validation error</span>';
                document.getElementById('addBtn').disabled = true;
            }
        }

        // Auto-validate on input with debounce
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('newSubreddit');
            input.addEventListener('input', () => {
                clearTimeout(validationDebounce);
                validationDebounce = setTimeout(() => {
                    if (input.value.trim()) {
                        validateSubreddit();
                    } else {
                        document.getElementById('validationStatus').innerHTML = '';
                        document.getElementById('addBtn').disabled = true;
                    }
                }, 500);
            });
            
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !document.getElementById('addBtn').disabled) {
                    addSubreddit();
                }
            });
        });

        async function addSubreddit() {
            if (!validatedSubreddit) return;
            
            try {
                document.getElementById('addBtn').disabled = true;
                document.getElementById('addBtn').textContent = '‚è≥ Adding...';
                
                const response = await fetch('/api/subreddits/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subreddit: validatedSubreddit.name })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to add subreddit');
                }
                
                showMessage(`‚úÖ Successfully added r/${validatedSubreddit.name}`);
                
                // Clear form
                document.getElementById('newSubreddit').value = '';
                document.getElementById('validationStatus').innerHTML = '';
                validatedSubreddit = null;
                
                // Reload subreddits
                await loadSubreddits();
                
            } catch (error) {
                console.error('Error adding subreddit:', error);
                showError('Error adding subreddit: ' + error.message);
            } finally {
                document.getElementById('addBtn').textContent = '‚ûï Add Subreddit';
                document.getElementById('addBtn').disabled = true;
            }
        }

        async function toggleSubreddit(subreddit, enabled) {
            try {
                const endpoint = enabled ? 'enable' : 'disable';
                const response = await fetch(`/api/subreddits/${endpoint}/${subreddit}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `Failed to ${endpoint} subreddit`);
                }
                
                showMessage(`r/${subreddit} ${enabled ? 'enabled' : 'disabled'}`);
                await loadSubreddits();
                
            } catch (error) {
                console.error(`Error toggling subreddit:`, error);
                showError(`Error: ` + error.message);
                await loadSubreddits(); // Reload to revert
            }
        }

        async function removeSubreddit(subreddit) {
            if (!confirm(`Are you sure you want to remove r/${subreddit}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/subreddits/remove/${subreddit}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to remove subreddit');
                }
                
                showMessage(`‚úÖ Removed r/${subreddit}`);
                await loadSubreddits();
                
            } catch (error) {
                console.error('Error removing subreddit:', error);
                showError('Error removing subreddit: ' + error.message);
            }
        }

        async function loadSuggestions() {
            try {
                document.getElementById('suggestionsLoading').style.display = 'block';
                document.getElementById('suggestionsContent').innerHTML = '';
                
                const response = await fetch('/api/subreddits/suggestions?limit=10');
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load suggestions');
                }
                
                const suggestionsDiv = document.getElementById('suggestionsContent');
                
                if (data.suggestions.length === 0) {
                    suggestionsDiv.innerHTML = '<div class="empty-state">üí≠ No suggestions available yet. Process more Reddit content to see suggestions!</div>';
                } else {
                    data.suggestions.forEach(suggestion => {
                        const card = document.createElement('div');
                        card.className = 'suggestion-card';
                        
                        const samples = suggestion.samplePosts.slice(0, 2).join('<br>‚Ä¢ ');
                        
                        card.innerHTML = `
                            <h4>r/${suggestion.subreddit} <span class="badge crypto">ü™ô Crypto-focused</span></h4>
                            <p><strong>Mentioned ${suggestion.mentionCount} times</strong></p>
                            ${samples ? `<p style="font-size: 12px;">‚Ä¢ ${samples}</p>` : ''}
                            <button class="btn small" onclick="quickAddSuggestion('${suggestion.subreddit}')">‚ûï Quick Add</button>
                        `;
                        
                        suggestionsDiv.appendChild(card);
                    });
                }
                
                document.getElementById('suggestionsLoading').style.display = 'none';
                
            } catch (error) {
                console.error('Error loading suggestions:', error);
                document.getElementById('suggestionsLoading').style.display = 'none';
                document.getElementById('suggestionsContent').innerHTML = '<div class="empty-state">‚ö†Ô∏è Error loading suggestions</div>';
            }
        }

        async function quickAddSuggestion(subreddit) {
            try {
                const response = await fetch('/api/subreddits/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subreddit })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to add subreddit');
                }
                
                showMessage(`‚úÖ Successfully added r/${subreddit}`);
                await loadSubreddits();
                
            } catch (error) {
                console.error('Error adding subreddit:', error);
                showError('Error adding subreddit: ' + error.message);
            }
        }

        // ============= WEBSOCKET LISTENERS =============
        socket.on('subredditAdded', (data) => {
            console.log('Subreddit added:', data);
            if (allSubreddits.length > 0) {
                loadSubreddits();
            }
        });

        socket.on('subredditRemoved', (data) => {
            console.log('Subreddit removed:', data);
            if (allSubreddits.length > 0) {
                loadSubreddits();
            }
        });

        socket.on('subredditEnabled', (data) => {
            console.log('Subreddit enabled:', data);
            if (allSubreddits.length > 0) {
                loadSubreddits();
            }
        });

        socket.on('subredditDisabled', (data) => {
            console.log('Subreddit disabled:', data);
            if (allSubreddits.length > 0) {
                loadSubreddits();
            }
        });

        // ============= INITIALIZATION =============
        document.addEventListener('DOMContentLoaded', () => {
            // Restore analytics preferences
            const savedDays = localStorage.getItem('tickerAnalytics_days');
            const savedBase = localStorage.getItem('tickerAnalytics_base');
            
            if (savedDays) {
                document.getElementById('analyticsTimeRange').value = savedDays;
            }
            if (savedBase) {
                document.getElementById('analyticsBaseCurrency').value = savedBase;
            }
            
            loadTickers().then(() => {
                // Auto-load analytics after tickers are loaded
                loadTickerAnalytics();
            });
            
            // Allow testing ticker on Enter key
            document.getElementById('testTicker').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    testTicker();
                }
            });
        });
    </script>
</body>
</html>
